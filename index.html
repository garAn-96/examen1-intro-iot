<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Monitoreo IoT</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

 <!-- Favicon -->
<link rel="icon" href="favicon.ico" type="image/x-icon">

<style>

/* Botones estilo moderno */
.nav-btn {
    padding: 8px 20px;
    border-radius: 30px;
    font-weight: 500;
    color: #333;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
}

/* Hover elegante */
.nav-btn:hover {
    background-color: #0d6efd;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(13,110,253,0.3);
}

/* Bot√≥n activo */
.active-custom {
    background-color: #092c3b;
    color: white !important;
    box-shadow: 0 4px 12px rgba(13,110,253,0.3);
}

/* Bot√≥n administraci√≥n especial */
.admin-btn {
    background-color: #092c3b;
    color: #f7f4f4;
}

.admin-btn:hover {
    background-color: #e0a800;
    color: #000;
}

footer {
      background-color: #333;
      color: #fff;
      text-align: center;
      padding: 10px 0;
      font-size: 14px;
    }


</style>

</head>

<!-- PESTA√ëAS -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-3">
  <div class="container d-flex justify-content-center">

    <div class="nav nav-pills gap-3">

      <a href="index.html"
         class="nav-link nav-btn active-custom">
         Monitoreo
      </a>

      <a href="control.html"
         class="nav-link nav-btn">
         Control
      </a>

      <a href="admin.html"
         class="nav-link nav-btn admin-btn">
         Administraci√≥n
      </a>

    </div>

  </div>
</nav>


<body class="bg-light">

<!-- MODAL HISTORIAL -->
<div class="modal fade" id="modalHistorial" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="tituloModal">Historial</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- GR√ÅFICA -->
        <canvas id="graficaModal" height="120"></canvas>

        <hr>

        <!-- TABLA HISTORIAL -->
        <table class="table table-sm table-striped mt-3">
          <thead>
            <tr>
              <th>Hora</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tablaHistorialModal"></tbody>
        </table>

      </div>

    </div>
  </div>
</div>


<div class="container mt-4">

<h2 class="text-primary mb-3">Dashboard de Monitoreo IoT de una casa Inteligente</h2>

<!-- MODO SISTEMA -->
<div class="alert alert-info" id="modoSistema">
Modo del sistema: ---
</div>

<!-- ALERTA -->
<div class="alert alert-success" id="alertaSeguridad">
üîí Sistema seguro ‚Äì sin alertas
</div>

<!-- GR√ÅFICAS -->
<div class="row" id="graficas"></div>

<hr>

<div class="row" id="contenedorDispositivos"></div>

<h4>Historial general (simulaci√≥n en tiempo real)</h4>

<table class="table table-striped">
<thead>
<tr>
<th>Hora</th>
<th>Dispositivo</th>
<th>Estado</th>
</tr>
</thead>
<tbody id="tablaGeneral"></tbody>
</table>

</div>


<script>
const API = "https://698a17f2c04d974bc6a155f8.mockapi.io/api/v1/dispositivos_IoT";

let dispositivos = [];
let charts = {};
let historial = []; // üëà historial en memoria
let historialPorDispositivo = {};
let graficaModal = null;

// Imagen por tipo
function imagenPorTipo(tipo){
    const base = "./img/";
    const t = tipo.toLowerCase();

    if(t.includes("puerta garaje")) return base + "garaje.jpg";
    if(t.includes("puerta")) return base + "puerta.jpg";
    if(t.includes("l√°mpara")) return base + "luz.jpg";
    if(t.includes("ventilador")) return base + "ventilador.jpg";
    if(t.includes("aire")) return base + "aire.jpg";

    return base + "casa.png"; // imagen por defecto segura
}


// üé® Clase seg√∫n estado
function claseEstado(d, modo){
    if(
        (d.tipo === "Garaje" || d.tipo === "Puerta entrada principal") &&
        d.estado === "ON" &&
        (modo === "DORMIDO" || modo === "FUERA")
    ){
        return "card-alert";
    }
    return d.estado === "ON" ? "card-on" : "card-off";
}


async function inicializar(){

    const res = await fetch(API);
    dispositivos = await res.json();

    const cont = document.getElementById("graficas");

    dispositivos.forEach(d=>{
        cont.innerHTML += `
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm p-3 text-center" id="card${d.id}">
                <img src="${imagenPorTipo(d.tipo)}"
                     style="width:80px;height:80px;margin:auto">

                <h5 class="mt-2">${d.nombre}</h5>

                <h4 id="estado${d.id}" class="fw-bold">${d.estado}</h4>

                <button class="btn btn-outline-primary btn-sm mt-2"
                onclick="abrirHistorial('${d.id}', '${d.nombre}')">
                Ver historial
                </button>


                <div class="collapse mt-3" id="historial${d.id}">
                    <canvas id="chart${d.id}" height="120"></canvas>
                </div>
            </div>
        </div>
        `;

        const ctx = document.getElementById(`chart${d.id}`);
        charts[d.id] = new Chart(ctx,{
            type:'line',
            data:{
                labels:[],
                datasets:[{
                    label:'Estado (1=ON, 0=OFF)',
                    data:[],
                    borderColor:'#0d6efd',
                    tension:0.3
                }]
                },
            options:{
                animation:false,
                scales:{ y:{ min:0, max:1 } }
            }
        });
    });

    actualizar();
    setInterval(actualizar,2000);
}

function actualizar(){

    const ahora = new Date().toLocaleTimeString();

    dispositivos.forEach(d=>{

        // Mostrar estado
        document.getElementById(`estado${d.id}`).innerHTML =
            `<strong>${d.estado}</strong>`;

        // Guardar historial en memoria
        historial.push({
            hora: ahora,
            nombre: d.nombre,
            estado: d.estado
        });

        if(historial.length > 10){
            historial.shift();
        }

        // Actualizar gr√°fica

         if(!historialPorDispositivo[d.id]){
                historialPorDispositivo[d.id] = [];
            }

            const valor = (d.estado === "ON" || d.estado === "ABIERTO") ? 1 : 0;

            historialPorDispositivo[d.id].push({
                hora: ahora,
                estado: d.estado, 
                valor: valor
            });

            if(historialPorDispositivo[d.id].length > 10){
                historialPorDispositivo[d.id].shift();
            }

            charts[d.id].data.labels.push(ahora);
            charts[d.id].data.datasets[0].data.push(valor);

            if(charts[d.id].data.labels.length > 10){
                charts[d.id].data.labels.shift();
                charts[d.id].data.datasets[0].data.shift();
            }

            charts[d.id].update();
    });

    // Tabla general
    const tabla = document.getElementById("tablaGeneral");
    tabla.innerHTML = "";

    historial.forEach(h=>{
        tabla.innerHTML += `
        <tr>
            <td>${h.hora}</td>
            <td>${h.nombre}</td>
            <td>${h.estado}</td>
        </tr>`;
    });

    // ALERTA

    const modo = dispositivos.find(d => d.tipo === "Sistema");

    let alertaActiva = false;

    dispositivos.forEach(d => {

    const esPuertaOGaraje =
        d.tipo === "Puerta Garaje" ||
        d.tipo === "Puerta";

    const estaAbierta = d.estado === "ON";

    const modoSeguro =
        modo?.estado === "DORMIDO" ||
        modo?.estado === "FUERA";

    if (esPuertaOGaraje && estaAbierta && modoSeguro) {
        alertaActiva = true;
    }
    });
    

    const alertaDiv = document.getElementById("alertaSeguridad");

    if (alertaActiva) {
    alertaDiv.className = "alert alert-danger";
    alertaDiv.innerHTML = "üö® ALERTA: Puerta o garaje ABIERTO";
    } else {
    alertaDiv.className = "alert alert-success";
    alertaDiv.innerHTML = "üîí Sistema seguro ‚Äì sin alertas";
    }

    document.getElementById("modoSistema").innerHTML =
        `Modo del sistema: <strong>${modo?.estado || "N/D"}</strong>`;
}
function abrirHistorial(id, nombre){

    document.getElementById("tituloModal").innerText =
        "Historial de " + nombre;

    const datos = historialPorDispositivo[id] || [];

    const labels = datos.map(d => d.hora);
    const valores = datos.map(d => d.valor);

    // TABLA
    const tabla = document.getElementById("tablaHistorialModal");
    tabla.innerHTML = "";

    datos.forEach(d => {
        tabla.innerHTML += `
        <tr>
            <td>${d.hora}</td>
            <td>
              <span class="badge ${d.valor === 1 ? 'bg-success' : 'bg-secondary'}">
                ${d.estado}
              </span>
            </td>
        </tr>`;
    });

    // GR√ÅFICA
    const ctx = document.getElementById("graficaModal");

    if (graficaModal) {
        graficaModal.destroy();
    }

    graficaModal = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Estado (1=ON, 0=OFF)',
                data: valores,
                borderColor: '#0d6efd',
                tension: 0.3
            }]
        },
        options: {
            animation: false,
            scales: {
                y: {
                    min: 0,
                    max: 1,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    const modal = new bootstrap.Modal(
        document.getElementById('modalHistorial')
    );
    modal.show();
}



inicializar();

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

 <footer>
    Creado y dise√±ado por <strong>Garcia Angeles Karen</strong> &copy; 2026
  </footer>

</body>
</html>
