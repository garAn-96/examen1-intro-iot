<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Control IoT</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="./assets/img/favicon.png">

<!-- CSS -->
<link rel="stylesheet" href="./assets/css/styles.css">

</head>

<!-- PESTA√ëAS -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-3">
  <div class="container d-flex justify-content-center">

    <div class="nav nav-pills gap-3">

      <a href="./index.html"
         class="nav-link nav-btn active-custom">
         Monitoreo
      </a>

      <a href="control.html"
         class="nav-link nav-btn">         Control
      </a>

      <a href="admin.html"
         class="nav-link nav-btn admin-btn">
         Administraci√≥n
      </a>

    </div>

  </div>
</nav>

<body class="bg-light">

<div class="container mt-4">

<h2 class="text-primary mb-3">Control de Dispositivos</h2>

<!-- ALERTA -->
<div id="alertaSeguridad" class="alert alert-success">
üîí Sistema seguro ‚Äì sin alertas
</div>

<!-- MODO SISTEMA -->
<div class="card p-4 mb-4 shadow-sm">
    <h4 class="text-center mb-3">Modo de la Vivienda</h4>
    <div class="modo-container">
        <button class="modo-btn modo-casa" onclick="cambiarModo('EN_CASA')">üè† EN CASA</button>
        <button class="modo-btn modo-dormido" onclick="cambiarModo('DORMIDO')">üåô DORMIDO</button>
        <button class="modo-btn modo-fuera" onclick="cambiarModo('FUERA')">üö® FUERA</button>
    </div>
</div>

<div class="row" id="contenedor"></div>

</div>


<script>
const API = "https://698a17f2c04d974bc6a155f8.mockapi.io/api/v1/dispositivos_IoT";
let dispositivos = [];

// Imagen por tipo
function imagenPorTipo(tipo){
    const base = "/assets/img/";
    const t = tipo.toLowerCase();

    if(t.includes("puerta garaje")) return base + "garaje.jpg";
    if(t.includes("puerta")) return base + "puerta.jpg";
    if(t.includes("l√°mpara")) return base + "luz.jpg";
    if(t.includes("ventilador")) return base + "ventilador.jpg";
    if(t.includes("aire")) return base + "aire.jpg";

    return base + "casa.png"; // imagen por defecto segura
}

/* CAMBIAR ESTADO */
async function cambiarEstado(id,estado){
    await fetch(`${API}/${id}`,{
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ estado })
    });
    cargar();
}

/* CAMBIAR MODO */
async function cambiarModo(modo){
    const sistema = dispositivos.find(d=>d.tipo==="Sistema");
    if(!sistema) return;
    await fetch(`${API}/${sistema.id}`,{
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ estado:modo })
    });

    cargar();
}

/* CREAR CARD */
function crearCard(d,modo){
    const alerta =
        (d.tipo.includes("Puerta")||d.tipo.includes("Garaje")) &&
        d.estado==="ON" &&
        (modo==="DORMIDO"||modo==="FUERA");

    const claseCard = alerta ? "card-alert" : (d.estado==="ON"?"card-on":"card-off");
    const claseEstado = d.estado==="ON"?"estado-on":"estado-off";

    return `
    <div class="col-md-4 mb-4">
        <div class="card ${claseCard} p-3 text-center">
            <img src="${imagenPorTipo(d.tipo)}" class="img-dispositivo">
            <h5>${d.nombre}</h5>
            <p>Tipo: ${d.tipo}</p>

            <p>
                Estado:
                <span class="${d.estado === 'ON' ? 'estado-on' : 'estado-off'}">
                    ${textoEstado(d)}
                </span>
            </p>

            <div class="d-flex gap-2 justify-content-center">
                <button class="btn ${d.estado==="ON"?"btn-on":"btn-inactivo"}"
                    onclick="cambiarEstado(${d.id},'ON')">ON</button>

                <button class="btn ${d.estado==="OFF"?"btn-off":"btn-inactivo"}"
                    onclick="cambiarEstado(${d.id},'OFF')">OFF</button>
            </div>
        </div>
    </div>`;
}

/* CARGAR */
async function cargar(){
    
    const res = await fetch(API);
    dispositivos = await res.json();

    const cont = document.getElementById("contenedor");
    cont.innerHTML="";

    const modo = dispositivos.find(d=>d.tipo==="Sistema")?.estado || "EN_CASA";

    let alerta=false;

    dispositivos.forEach(d=>{
      
        cont.innerHTML += crearCard(d,modo);

        if(
            (d.tipo.includes("Puerta")||d.tipo.includes("Garaje")) &&
            d.estado==="ON" &&
            (modo==="DORMIDO"||modo==="FUERA")
        ){
            alerta=true;
        }
    });

    const alertaDiv=document.getElementById("alertaSeguridad");
    if(alerta){
        alertaDiv.className="alert alert-danger";
        alertaDiv.innerHTML="üö® ALERTA: Acceso abierto";
    }else{
        alertaDiv.className="alert alert-success";
        alertaDiv.innerHTML="üîí Sistema seguro ‚Äì sin alertas";
    }
    

}
function textoEstado(d){
    const tipo = d.tipo.toLowerCase();

    if(tipo.includes("puerta") || tipo.includes("puerta garaje")){
        return d.estado === "ON" ? "ABIERTO" : "CERRADO";
    }

    return d.estado; // luces, ventiladores, etc.
}


cargar();
</script>

<footer>
    Creado y dise√±ado por <strong>Garcia Angeles Karen</strong> &copy; 2026
  </footer>

</body>
</html>
